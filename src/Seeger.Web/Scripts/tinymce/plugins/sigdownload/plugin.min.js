
(function () {

    var dialog = new sig.ui.SelectFileDialog({
        allowMultiSelect: true,
        onOK: function (files) {
            var editor = dialog.tinyMCEEditor;
            if (!editor)
                throw new Error('TinyMCE Editor must be set first.');

            var dom = editor.dom;

            for (var i = 0, len = files.length; i < len; i++) {
                var file = files[i];
                editor.execCommand('mceInsertContent', false,
                    dom.createHTML(
                        'a', 
                        {
                            href: file.publicUri
                        },
                        sig.UrlUtil.getFileName(file.publicUri)
                    )
                );
            }

            dialog.close();
        }
    });

    tinymce.create('tinymce.plugins.SigDownloadPlugin', {
        init: function (ed, url) {

            // Register commands
            ed.addCommand('mceSigDownload', function () {
                // Internal image object like a flash placeholder
                if (ed.dom.getAttrib(ed.selection.getNode(), 'class').indexOf('mceItem') != -1) return;

                dialog.tinyMCEEditor = ed;
                dialog.open();
            });

            // Register buttons
            ed.addButton('sigimage', {
                title: sig.Resources.get('Insert Image'),
                cmd: 'mceSigImage'
            });

            // Register buttons
            ed.addButton('sigdownload', {
                title: sig.Resources.get('Insert File'),
                cmd: 'mceSigDownload'
            });
        },

        getInfo: function () {
            return {
                longname: 'Seeger download',
                author: 'Seeger CMS',
                authorurl: 'http://www.seegercms.com',
                infourl: 'http://www.seegercms.com',
                version: tinymce.majorVersion + "." + tinymce.minorVersion
            };
        }
    });

    // Register plugin
    tinymce.PluginManager.add('sigdownload', tinymce.plugins.SigDownloadPlugin);
})();